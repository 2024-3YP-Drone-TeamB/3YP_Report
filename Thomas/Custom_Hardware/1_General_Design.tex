\subsection{Design Considerations}\label{sub_section:tgt_design_considerations}

\subsubsection{Built for compliance}
\paragraph{Regulations}
Compliance to local laws is an important part of \gls{PCB} design, to operate in the European Union it would need to be CE compliant and for general use it should be up to IPC-2221 standards\footnote{\url{https://www-eng.lbl.gov/~shuman/NEXT/CURRENT_DESIGN/TP/MATERIALS/IPC-2221A(L).pdf}}. To ensure the design was up to IPC-2221 standards all spacings and widths of traces are compliant throughout the design. To ensure a smooth compliance process for CE it was ensured all components are \gls{RoHS} compliant and all solder is lead free. Furthermore, at all times the industry standard best practices as outlined in IPC-2221 standards were followed.
\paragraph{Process}
Compliance is often confirmed by 3rd party labs, TUV SUD offers UA DoC (EMC) which is required for products under 75 VDC in Ukraine with the CE as pre-requisite\footnote{\url{https://www.tuvsud.com/en-us/services/product-certification/ukraine-safety-certification}}. However, before being sent to external labs it should be internally tested for \gls{EMI}, thermal stability and vibration robustness with rapid prototyping to ensure minimal redesigns are needed.

\subsubsection{Trace Lengths}\label{sub_sub_section:tgt_trace_lengths}
\paragraph{Signal Integrity and Timing}
All traces have propagation delay that increases linearly with length meaning that the longer the trace, the longer the delay. Furthermore, noise increases due to impurities and crosstalk. Therefore, trace length is minimised in the design process. Therefore, in all custom designs the large footprint devices such as connectors are placed at the edges and the \gls{MCU} is placed centrally.
\paragraph{Length Matching}
In synchronous communication methods the clock signal must be in sync with the data transmission. This means that the lines should be as similar in length as possible so that they arrive at the same delay. The faster the communication rate the stricter this must become as the clock signal frequency is increased.
\paragraph{Effect of vias}
Vias allow for the transference of signals between planes which is necessary for routing signals. However, they should be avoided as they introduce extra impedance, noise and delay. Furthermore, for synchronous high speed signals they should be included in trace length considerations as the line with fewer vias should be tuned to have a longer length to achieve the same delay.
\paragraph{Utility Regions}
Components with similar functionalities should be restricted to specific regions, this is because it reduces trace length, prevents interference between high and low frequency signals and makes thermal management easier. These regions are shown in Figure \ref{fig:custom_hardware_overview} for the custom components.

\subsubsection{Circuit Protection}\label{sub_sub_section:tgt_circuit_protection}
\paragraph{\gls{ESD}}
\gls{ESD} occurs when there is a significant static charge built up in a ground operator or contacting surface that is then shorted in contact with the board causing a current transient and circuit damage. IEC 61000-4-2 level 4 is the highest IEC 61000-4-2 standard at 8 kV contact/15 kV\footnote{\url{https://www.ti.com/document-viewer/lit/html/SSZT871}} and will be considered a lower bound specification for the design. 
\paragraph{Touch Protection Devices}
In order to protect against \gls{ESD} the circuit must provide a low resistance pathway to the ground. This can be using \gls{TVS} diodes that above certain voltages act like a wire that diverts the current flow\footnote{\url{https://resources.altium.com/p/pcb-design-guidelines-using-tvs-diode-transient-protection}}. In my designs I use the \gls{TVS} diode produced by Vishay (Part number: VCUT03G1-SD0) bidirectional \gls{TVS} diode that are rated to 30kV in both contact and air gap\footnote{\url{https://www.vishay.com/docs/86315/vcut03g1-sd0.pdf}} to ensure to \gls{ESD} protection. 
\paragraph{Over current protection}
Series resistors are the best way to protect a device against transient current spikes as they mitigate the peak current. Therefore, for serial debugging terminals I ensured that all connections have 100$\ohm$ series resistors in case of accidental short circuits by the user, this is only appropriate in signal traces however, as otherwise the power dissipation in normal operation is too high. Therefore, 2.6A fuses are used in the power lines of both modules to protect against short circuits, I selected a resettable manufactured by Bourns (Part number: MF-LSMF260/6X-2) in order to ensure it can be repaired easily in the field. Both these measures are in line with IPC-2221 standards.
\paragraph{Placement}
Protections should be as close to possible sources so the least number of components and wires get damaged in failure. Therefore, all \gls{TVS} diodes are placed near touched areas or interfaces, series resistors are placed as close as possible to prevent wire transients and fuses are placed before the power is connected to the power and ground planes. This minimises the damage potential.

\subsubsection{Trace Widths and Spacing}\label{sub_sub_section:tgt_trace_width}
\paragraph{Impedance Control}
The copper thickness is a key metric in the cost of a \gls{PCB} as the material cost is the most significant cost and manufacturers typically have fixed options. The thinnest standard option offered by PCBway is 1 Oz/foot$^2$ foot of copper and therefore I used this throughout my designs. To control the impedance of a trace calculated trace widths using the industry standard IPC-2221 compliance formula\footnote{\url{https://resources.altium.com/p/ipc-2221-calculator-pcb-trace-current-and-heating}} to ensure it is compliant with industry standard practices. Setting the expectable temperature rise to 10\degree C and thickness to 1 Oz/foot$^2$, a trace of width 12 mil (0.3048mm) is rated up to 1A and a trace width of 6 mil (0.1528mm) is rated at over 0.6A. Given that traces below 6 mil incur extra manufacturing cost\footnote{\url{https://www.pcbway.com/pcb_prototype/PCB_Design_Rule_Check.html}} for signals 6 mil traces are used and for power-carrying traces 12 mil traces are used.
\paragraph{Crosstalk}
When traces are too close too each other they can induce signals in each other, this causes inaccuracies that can cause Analogue to Digital converter to have bit errors\footnote{\url{https://resources.altium.com/p/crosstalk-basics-pcb-design?}}. Therefore, the Radio Frequency input for the \gls{GNSS} module is kept away from all other components and the ground and voltage planes as shown in Figure \ref{fig:gnss_render}) to ensure that there is no mutual inductance. This ensures that the designs reduce the effect of \gls{EMI} in line with IPC-2221 standards and CE certification.

\subsubsection{Layers}\label{sub_sub_section:tgt_layers}
\paragraph{Two Layers}
The simplest and most cost effective option in \gls{PCB} design is two copper layers separated by a dielectric. By using a copper filled regions you can create a ground plane and a power plane that effectively distribute charge and maintain voltage integrity. The simplicity of the \gls{GNSS} module means that two layers is the best option. This comes at the cost of more difficult component placement and a slightly less stable power and ground plane. To mitigate the instability, distributed ceramic capacitors between the planes that filter high frequency noise in voltage levels, maintaining integrity. These capacitors are best placed next to sensors and processers to ensure stable, low noise readings. .
\paragraph{Four or More Layers}
When circuits become more complex, a purpose ground and power plane in between the top and bottom plane can allow for greater packing density of components. It also mitigates the effect of \gls{EMI} as dedicated planes have a lower impedance. This means that for complex designs with many sensors, like the flight controller module, four layer \gls{PCB}s are the best option. Furthermore, if the complexity of the design is greater you can add further ground and power planes for analogue signals, high frequency signals or for regular signals to support greater component density and \gls{EMI} reduction. For the flight controller I used signal-ground-power-signal layers to minimise loop inductance.

\subsection{Debugging and Interfaces}\label{sub_sub_section:debugging}
\paragraph{Technical Debugging}
There easy to use male pin headers in both designs shown in Figure \ref{fig:custom_hardware_overview} so that a \gls{SWD} debugger can be connected, furthermore, for signalling debugging the detachable ports for the \gls{CAN} bus mean a debugging computer can simply connect. This is so technically skilled operators can inspect system level signals and specific board operations.
\paragraph{Field Debugging}
The use of technical debugging experts should always be avoided if possible to reduce capital expenditure and delay. Therefore the custom flight controller has a simple 4 \gls{LED} array for basic error codes that can isolate the problem so it can be fixed or so that only a specific, replaceable component, can be sent for repair and switched out with a backup. These codes are shown in Table \ref{tab:error_codes} where the colours are the \gls{LED}s and the x denotes blinking, the null state is a solid green \gls{LED} only.  The inclusion of the green LED has three key purposes: firstly, it blinks to denote between modules, secondly it gives clear visualisation that no tests have failed and lastly it ensures the codes are red in the right order no matter the orientation. It is also a different brightness to the red \gls{LED}s allowing for use by colour-blind operators in line with the inclusion objectives of the project.
\input{Thomas/Custom_Hardware/error_codes}
\paragraph{Post Failure Analysis}
If there is a crash that causes significant damage, and due to the volatile nature of \gls{RAM} memory, some failures cannot be detected directly with the device. Therefore, the flight controller has a removable microSD card to record flight data. In addition, the backup power supply, as seen in Figure \ref{fig:custom_hardware_overview}, provides enough power that even in complete failure it can write the final few error messages. Therefore, this can be retrieved, downloaded and sent for analysis quickly to find the source of failure.
\paragraph{Interfaces}
It is important that all interfaces between modules are easy to access, protected and consistent. For both designs screw-in connectors are used for the battery supply to ensure a strong power connection whilst also being removable. For all communication signals a 3 pin JST connector with locking ensuring any disconnections due to vibrations are minimised. For the \gls{CAN} signals the third pin is used as a shared ground so the signals do not drift between boards and all have a shared ground level. Lastly, for the debugging interface male Dupont header is used so that the user can attach wires easily. All interfaces are protected with \gls{TVS} diodes to ensure no accidental \gls{ESD} events when connecting or disconnecting.


\begin{comment}
\subsubsection{Component Placement}\label{sub_sub_section:tgt_component_placement}

\paragraph{Thermal Considerations}
Heat dissipating elements, typically diodes and resistors, can cause damage to electronic component, therefore, heat sinks or controlled airflows are sometimes required. This consideration is why on my devices Buck Converters of above 90\% are used instead of the less efficient \gls{LDO} which would have an efficiency of 66\% when converting from 5V to 3.3V. This, in addition to the low power draws of all other components, means that no explicit thermal management is needed.
\end{comment}